{"ast":null,"code":"// src/utils/graph.js\nimport { acquireToken } from \"./auth\";\n\n// --- Cliente base para Microsoft Graph ---\nconst graphFetch = async (endpoint, options = {}) => {\n  const token = await acquireToken();\n  const res = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, {\n    ...options,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${token}`,\n      ...(options.headers || {})\n    }\n  });\n  if (!res.ok) {\n    const text = await res.text().catch(() => \"\");\n    throw new Error(`Graph error ${res.status}: ${text || res.statusText}`);\n  }\n  return res.status === 204 ? null : res.json();\n};\n\n// --- Utilidades ---\nconst toUTC = d => new Date(d).toISOString(); // ISO en UTC\n\n// Si quieres poder desactivar Teams por reserva, permite flag opcional en la reserva\nconst shouldCreateTeams = reservation => (reservation === null || reservation === void 0 ? void 0 : reservation.createTeams) === undefined ? true : !!reservation.createTeams;\nconst normalizeAttendees = reservation => {\n  const list = Array.isArray(reservation === null || reservation === void 0 ? void 0 : reservation.attendees) ? reservation.attendees : [];\n  return list.map(email => typeof email === \"string\" ? email.trim() : \"\").filter(Boolean).map(email => ({\n    emailAddress: {\n      address: email\n    },\n    type: \"required\"\n  }));\n};\n\n// --- Mapeo: reserva -> evento de Graph ---\nconst toGraphEvent = reservation => {\n  var _reservation$room;\n  return {\n    subject: reservation.title,\n    body: {\n      contentType: \"HTML\",\n      content: reservation.description || \"\"\n    },\n    start: {\n      dateTime: toUTC(reservation.startTime),\n      timeZone: \"UTC\"\n    },\n    end: {\n      dateTime: toUTC(reservation.endTime),\n      timeZone: \"UTC\"\n    },\n    // Ubicación visible en Outlook (coincide con tu UI)\n    location: {\n      displayName: ((_reservation$room = reservation.room) === null || _reservation$room === void 0 ? void 0 : _reservation$room.nombre) || \"Sala\"\n    },\n    // Teams (por defecto activado). Si no lo quieres por defecto, pon false en shouldCreateTeams.\n    isOnlineMeeting: shouldCreateTeams(reservation),\n    onlineMeetingProvider: \"teamsForBusiness\",\n    // Recordatorio\n    isReminderOn: true,\n    reminderMinutesBeforeStart: 15,\n    // Categoría opcional (puedes crearla en Outlook para asignarle color)\n    categories: [\"Salas FYCO\"],\n    // Invitados opcionales\n    attendees: normalizeAttendees(reservation)\n  };\n};\n\n// --- Operaciones de calendario personal ---\nexport const graphCreateEvent = async reservation => graphFetch(`/me/events`, {\n  method: \"POST\",\n  body: JSON.stringify(toGraphEvent(reservation))\n});\nexport const graphUpdateEvent = async (eventId, reservation) => graphFetch(`/me/events/${eventId}`, {\n  method: \"PATCH\",\n  body: JSON.stringify(toGraphEvent(reservation))\n});\nexport const graphDeleteEvent = async eventId => graphFetch(`/me/events/${eventId}`, {\n  method: \"DELETE\"\n});\n\n// --- Chequeo de conflictos en el calendario personal del usuario ---\n// Excluye el propio evento cuando estás editando (excludeEventId).\nexport const graphHasConflict = async (startISO, endISO, excludeEventId) => {\n  const params = new URLSearchParams({\n    startDateTime: startISO,\n    endDateTime: endISO,\n    $select: \"id,subject,start,end,showAs\"\n  });\n  const data = await graphFetch(`/me/calendar/calendarView?${params.toString()}`);\n  const events = Array.isArray(data === null || data === void 0 ? void 0 : data.value) ? data.value : [];\n  return events.some(ev => {\n    if (excludeEventId && ev.id === excludeEventId) return false; // no cuentes el mismo\n    const show = (ev.showAs || \"\").toLowerCase();\n    // Si no viene showAs, asumimos ocupado. Si viene, solo marcamos conflicto si no es \"free\".\n    const isBusy = show ? show !== \"free\" : true;\n    return isBusy;\n  });\n};","map":{"version":3,"names":["acquireToken","graphFetch","endpoint","options","token","res","fetch","headers","Authorization","ok","text","catch","Error","status","statusText","json","toUTC","d","Date","toISOString","shouldCreateTeams","reservation","createTeams","undefined","normalizeAttendees","list","Array","isArray","attendees","map","email","trim","filter","Boolean","emailAddress","address","type","toGraphEvent","_reservation$room","subject","title","body","contentType","content","description","start","dateTime","startTime","timeZone","end","endTime","location","displayName","room","nombre","isOnlineMeeting","onlineMeetingProvider","isReminderOn","reminderMinutesBeforeStart","categories","graphCreateEvent","method","JSON","stringify","graphUpdateEvent","eventId","graphDeleteEvent","graphHasConflict","startISO","endISO","excludeEventId","params","URLSearchParams","startDateTime","endDateTime","$select","data","toString","events","value","some","ev","id","show","showAs","toLowerCase","isBusy"],"sources":["/Users/mairaquintero/Desktop/project-salas/src/utils/graph.js"],"sourcesContent":["// src/utils/graph.js\nimport { acquireToken } from \"./auth\";\n\n// --- Cliente base para Microsoft Graph ---\nconst graphFetch = async (endpoint, options = {}) => {\n  const token = await acquireToken();\n  const res = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, {\n    ...options,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${token}`,\n      ...(options.headers || {}),\n    },\n  });\n  if (!res.ok) {\n    const text = await res.text().catch(() => \"\");\n    throw new Error(`Graph error ${res.status}: ${text || res.statusText}`);\n  }\n  return res.status === 204 ? null : res.json();\n};\n\n// --- Utilidades ---\nconst toUTC = (d) => new Date(d).toISOString(); // ISO en UTC\n\n// Si quieres poder desactivar Teams por reserva, permite flag opcional en la reserva\nconst shouldCreateTeams = (reservation) =>\n  reservation?.createTeams === undefined ? true : !!reservation.createTeams;\n\nconst normalizeAttendees = (reservation) => {\n  const list = Array.isArray(reservation?.attendees) ? reservation.attendees : [];\n  return list\n    .map((email) => (typeof email === \"string\" ? email.trim() : \"\"))\n    .filter(Boolean)\n    .map((email) => ({\n      emailAddress: { address: email },\n      type: \"required\",\n    }));\n};\n\n// --- Mapeo: reserva -> evento de Graph ---\nconst toGraphEvent = (reservation) => ({\n  subject: reservation.title,\n  body: { contentType: \"HTML\", content: reservation.description || \"\" },\n\n  start: { dateTime: toUTC(reservation.startTime), timeZone: \"UTC\" },\n  end:   { dateTime: toUTC(reservation.endTime),   timeZone: \"UTC\" },\n\n  // Ubicación visible en Outlook (coincide con tu UI)\n  location: { displayName: reservation.room?.nombre || \"Sala\" },\n\n  // Teams (por defecto activado). Si no lo quieres por defecto, pon false en shouldCreateTeams.\n  isOnlineMeeting: shouldCreateTeams(reservation),\n  onlineMeetingProvider: \"teamsForBusiness\",\n\n  // Recordatorio\n  isReminderOn: true,\n  reminderMinutesBeforeStart: 15,\n\n  // Categoría opcional (puedes crearla en Outlook para asignarle color)\n  categories: [\"Salas FYCO\"],\n\n  // Invitados opcionales\n  attendees: normalizeAttendees(reservation),\n});\n\n// --- Operaciones de calendario personal ---\nexport const graphCreateEvent = async (reservation) =>\n  graphFetch(`/me/events`, {\n    method: \"POST\",\n    body: JSON.stringify(toGraphEvent(reservation)),\n  });\n\nexport const graphUpdateEvent = async (eventId, reservation) =>\n  graphFetch(`/me/events/${eventId}`, {\n    method: \"PATCH\",\n    body: JSON.stringify(toGraphEvent(reservation)),\n  });\n\nexport const graphDeleteEvent = async (eventId) =>\n  graphFetch(`/me/events/${eventId}`, { method: \"DELETE\" });\n\n// --- Chequeo de conflictos en el calendario personal del usuario ---\n// Excluye el propio evento cuando estás editando (excludeEventId).\nexport const graphHasConflict = async (startISO, endISO, excludeEventId) => {\n  const params = new URLSearchParams({\n    startDateTime: startISO,\n    endDateTime: endISO,\n    $select: \"id,subject,start,end,showAs\",\n  });\n  const data = await graphFetch(`/me/calendar/calendarView?${params.toString()}`);\n\n  const events = Array.isArray(data?.value) ? data.value : [];\n  return events.some((ev) => {\n    if (excludeEventId && ev.id === excludeEventId) return false; // no cuentes el mismo\n    const show = (ev.showAs || \"\").toLowerCase();\n    // Si no viene showAs, asumimos ocupado. Si viene, solo marcamos conflicto si no es \"free\".\n    const isBusy = show ? show !== \"free\" : true;\n    return isBusy;\n  });\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}